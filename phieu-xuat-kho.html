<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Phiếu xuất kho - In / Xuất PDF</title>
<style>
  :root{--accent:#0b5ed7;--muted:#666}
  body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:20px;color:#111;background:#f5f6f7}
  .container{max-width:800px;margin:0 auto;padding:18px;border:1px solid #e3e3e3;background:#fff}
  header{display:flex;justify-content:space-between;align-items:center}
  .company{font-weight:700;font-size:18px}
  .meta{ text-align:right;font-size:13px;color:var(--muted) }
  h1{text-align:center;margin:12px 0;font-size:20px}
  table{width:100%;border-collapse:collapse}
  td,th{padding:6px;border:1px solid #ddd;font-size:13px}
  .items th{background:#f7f7f7}
  .controls{margin:14px 0;display:flex;gap:10px}
  button{padding:8px 12px;border-radius:6px;border:0;background:var(--accent);color:#fff;cursor:pointer}
  button.alt{background:#6c757d}
  @media print{body{padding:0}.controls{display:none}.container{border:0;margin:0}}
  .a4-wrapper{width:210mm;min-height:297mm;padding:12mm;margin:0 auto;background:#fff}
</style>
</head>
<body>
  <div class="controls">
    <button id="btnPrint">In (Print)</button>
    <button id="btnPdf">Xuất PDF (A4)</button>
    <button id="btnLoadApi" class="alt">Tải từ API</button>
    <input id="apiUrlInput" type="text" placeholder="API URL (tùy chọn)" style="width:420px">
  </div>

  <div class="container a4-wrapper" id="printArea">
    <header>
      <div>
        <div class="company" id="companyName">Công ty: _________</div>
        <div style="font-size:13px;color:var(--muted)" id="companyAddr">Địa chỉ: _________</div>
      </div>
      <div class="meta">
        <div>Số phiếu: <strong id="soPhieu">-</strong></div>
        <div id="ngayXuatMeta">Ngày: -</div>
      </div>
    </header>

    <h1>PHIẾU XUẤT KHO</h1>

    <table>
      <tr>
        <td><strong>Hạng mục</strong></td><td id="hangMuc">-</td><td><strong>Nhóm NCC</strong></td><td id="nhomNcc">-</td>
      </tr>
      <tr>
        <td><strong>Nội dung</strong></td><td id="noiDung">-</td><td><strong>Nhà cung cấp</strong></td><td id="nhaCung">-</td>
      </tr>
      <tr>
        <td><strong>Xưởng</strong></td><td id="xuong">-</td><td><strong>Trạng thái</strong></td><td id="trangThai">-</td>
      </tr>
      <tr>
        <td><strong>Ghi chú</strong></td><td id="ghiChu">-</td><td><strong>Người lập</strong></td><td id="nguoiLap">-</td>
      </tr>
    </table>

    <h3 style="margin-top:12px">Danh sách mặt hàng</h3>
    <table class="items" id="itemsTable">
      <thead>
        <tr><th style="width:6%">STT</th><th style="width:52%">Tên hàng</th><th style="width:12%">Đơn vị</th><th style="width:12%">Số lượng</th><th style="width:18%">Ghi chú</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <div style="display:flex;justify-content:space-between;margin-top:20px">
      <div>
        <div style="font-size:13px;color:var(--muted)">Người nhận</div>
        <div style="margin-top:36px">(Ký, ghi rõ họ tên)</div>
      </div>
      <div>
        <div style="font-size:13px;color:var(--muted)">Người lập</div>
        <div style="margin-top:36px" id="nguoiLapSign">-</div>
      </div>
    </div>
  </div>

  <!-- libs for PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* --------- UTILS --------- */
function safeTextField(f) {
  if (f === undefined || f === null) return '';
  if (typeof f === 'string') return f.trim();
  if (Array.isArray(f) && f.length) {
    // prefer object.text
    const fn = f.find(x => x && typeof x === 'object' && 'text' in x);
    if (fn && fn.text) return String(fn.text).trim();
    return String(f[0]).trim();
  }
  if (typeof f === 'object') {
    if ('text' in f) return String(f.text).trim();
    if ('value' in f && Array.isArray(f.value) && f.value.length) {
      // sometimes item_string.value is array of {text: 'a~b~c'}
      const v0 = f.value[0];
      if (v0 && typeof v0 === 'object' && 'text' in v0) return String(v0.text).trim();
      return String(f.value[0]).trim();
    }
    return JSON.stringify(f);
  }
  return String(f);
}

function parseItemFromRow(it){
  // Accept forms:
  // 1) {name, unit, qty, note} -> already formatted
  // 2) {record_id} -> no details (placeholder)
  // 3) {fields: {...}} -> parse from fields
  // 4) item_string pattern -> parse "~" delimited parts
  if (!it) return { name:'', unit:'', qty:'', note:'', record_id: it?.record_id || null };

  // already formatted
  if (it.name || it.unit || it.qty || it.note) {
    return {
      record_id: it.record_id || it.recordId || it.id || null,
      name: safeTextField(it.name),
      unit: safeTextField(it.unit),
      qty:  safeTextField(it.qty),
      note: safeTextField(it.note)
    };
  }

  // if item contains fields key (backend raw)
  if (it.fields) {
    const f = it.fields;
    // common keys seen in your Data: "Tên VTHH", "Đơn vị tính", "Số lượng" or item_string
    let name = safeTextField(f["Tên VTHH"] || f["Tên Vật tư"] || f["Tên"] || f["name"]);
    let unit = safeTextField(f["Đơn vị tính"] || f["Đơn vị"] || f["unit"]);
    let note = safeTextField(f["Ghi chú"] || f["note"]);
    let qty  = '';

    // try item_string parsing pattern: value[0].text -> "Name~Unit~Qty~"
    try {
      const itemStr = f["item_string"] || f["item_str"] || f["item"];
      if (itemStr && typeof itemStr === 'object') {
        const val = itemStr.value || itemStr["value"];
        if (Array.isArray(val) && val.length) {
          const t0 = safeTextField(val[0]); // maybe "Tủ trung tâm...~Tủ~ - ~"
          const mparts = t0.split('~').map(s=>s.trim());
          if (!name && mparts[0]) name = mparts[0];
          if (!unit && mparts[1]) unit = mparts[1];
          if (mparts[2]) qty = mparts[2];
        }
      }
    } catch(e){ /*ignore*/ }

    // fallback check explicit quantity field
    if (!qty) {
      qty = safeTextField(f["Số lượng"] || f["qty"] || f["Quantity"]);
    }

    return {
      record_id: it.record_id || it.id || null,
      name, unit, qty, note
    };
  }

  // if only record_id present -> placeholder (frontend can't fetch secret data)
  if (it.record_id && !it.name) {
    return { record_id: it.record_id, name:'', unit:'', qty:'', note:'' };
  }

  // last fallback: try to treat it as plain string encoded list
  if (typeof it === 'string') {
    const parts = decodeURIComponent(it).split(';;').map(s=>s.trim()).filter(Boolean);
    if (parts.length) {
      const [name, unit, qty, note] = parts[0].split('~').map(s=>s.trim());
      return { record_id: null, name: name||'', unit:unit||'', qty:qty||'', note:note||'' };
    }
  }

  return { record_id: it.record_id || null, name:'', unit:'', qty:'', note:'' };
}

/* --------- RENDERING --------- */
function fillData(data) {
  // meta
  document.getElementById('soPhieu').textContent = data.so_phieu || data.so || '-';
  document.getElementById('hangMuc').textContent = data.hang_muc || '-';
  document.getElementById('nhomNcc').textContent = data.nhom_ncc || '-';
  document.getElementById('noiDung').textContent = data.noi_dung || '-';
  document.getElementById('nhaCung').textContent = data.nha_cung || '-';
  document.getElementById('xuong').textContent = data.xuong || '-';
  document.getElementById('trangThai').textContent = data.trang_thai || '-';
  document.getElementById('ghiChu').textContent = data.ghi_chu || '-';
  document.getElementById('nguoiLap').textContent = data.nguoi_lap || '-';
  document.getElementById('nguoiLapSign').textContent = data.nguoi_lap || '-';
  if (data.ngay_xuat) document.getElementById('ngayXuatMeta').textContent = 'Ngày: ' + data.ngay_xuat;

  // items: robust parse
  const itemsRaw = data.items || data.danh_sach || [];
  const parsed = (Array.isArray(itemsRaw) ? itemsRaw : (typeof itemsRaw === 'string' ? [itemsRaw] : []))
                 .map(parseItemFromRow);

  // if parsed items have empty name but record_id present -> backend not returning details.
  // show a message to user in that case (helpful)
  const allEmpty = parsed.every(it => !it.name && !it.unit && !it.qty && !it.note);
  if (allEmpty && parsed.length) {
    console.warn("Items array contains only record_id, not detailed fields. Ensure backend returns full items (batch_get).");
    // optionally show a small notice
    const noteEl = document.getElementById('apiNotice');
    if (noteEl) noteEl.textContent = "Lưu ý: Items chỉ có record_id. Hãy kiểm tra backend (DATA_APP_TOKEN/DATA_TABLE_ID).";
  }

  // render table rows (ensure at least 8 rows)
  const tbody = document.querySelector('#itemsTable tbody');
  tbody.innerHTML = '';
  const rowsToShow = Math.max(parsed.length, 8);
  for (let i = 0; i < rowsToShow; i++) {
    const it = parsed[i] || {name:'', unit:'', qty:'', note:''};
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td>
                    <td>${escapeHtml(it.name||'')}</td>
                    <td>${escapeHtml(it.unit||'')}</td>
                    <td>${escapeHtml(it.qty||'')}</td>
                    <td>${escapeHtml(it.note||'')}</td>`;
    tbody.appendChild(tr);
  }
}

function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]||c)); }

/* --------- Load from API using api_url param or api_default --------- */
const API_DEFAULT = '';

function getParams(){
  const params = new URLSearchParams(location.search);
  const obj = {};
  for (const [k,v] of params.entries()) obj[k]=v;
  return obj;
}

async function loadFromApi(apiUrl){
  if(!apiUrl) apiUrl = API_DEFAULT;
  if(!apiUrl) { alert('Chưa cấu hình API. Nhập API URL vào ô rồi thử lại.'); return; }
  try {
    const r = await fetch(apiUrl, {method:'GET'});
    if(!r.ok) throw new Error('Status ' + r.status);
    const data = await r.json();
    // show raw json at bottom for debugging (optional)
    const dbgNode = document.getElementById('api-debug');
    if (dbgNode) dbgNode.textContent = JSON.stringify(data, null, 2);
    fillData(data);
  } catch(err){
    console.error(err);
    alert('Lấy dữ liệu từ API thất bại: ' + err.message + '. Kiểm tra CORS / URL.');
  }
}

// auto-run on load: prefer query param api_url
(function(){
  const params = getParams();
  if(params.api_url){
    const api = decodeURIComponent(params.api_url);
    document.getElementById('apiUrlInput').value = api;
    loadFromApi(api);
    return;
  }
  if(params.so){
    // fallback: you may call your own api by so directly if your backend supports path param
    const apiPath = 'https://phieu-in.vercel.app/api/phieu/' + encodeURIComponent(params.so);
    document.getElementById('apiUrlInput').value = apiPath;
    loadFromApi(apiPath);
    return;
  }
})();
</script>
</body>
</html>
