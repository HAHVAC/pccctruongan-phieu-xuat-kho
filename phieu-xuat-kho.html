<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Phiếu xuất kho - In / Xuất PDF</title>
<style>
  :root{--accent:#0b5ed7;--muted:#666}
  body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:20px;color:#111;background:#f5f6f7}
  .container{max-width:800px;margin:0 auto;padding:18px;border:1px solid #e3e3e3;background:#fff}
  header{display:flex;justify-content:space-between;align-items:center}
  .company{font-weight:700;font-size:18px}
  .meta{ text-align:right;font-size:13px;color:var(--muted) }
  h1{text-align:center;margin:12px 0;font-size:20px}
  table{width:100%;border-collapse:collapse}
  td,th{padding:6px;border:1px solid #ddd;font-size:13px}
  .items th{background:#f7f7f7}
  .controls{margin:14px 0;display:flex;gap:10px}
  button{padding:8px 12px;border-radius:6px;border:0;background:var(--accent);color:#fff;cursor:pointer}
  button.alt{background:#6c757d}
  @media print{body{padding:0}.controls{display:none}.container{border:0;margin:0}}
  .a4-wrapper{width:210mm;min-height:297mm;padding:12mm;margin:0 auto;background:#fff}
</style>
</head>
<body>
  <div class="controls">
    <button id="btnPrint">In (Print)</button>
    <button id="btnPdf">Xuất PDF (A4)</button>
    <button id="btnLoadApi" class="alt">Tải từ API</button>
    <input id="apiUrlInput" type="text" placeholder="API URL (tùy chọn)" style="width:420px">
  </div>

  <div class="container a4-wrapper" id="printArea">
    <header>
      <div>
        <div class="company" id="companyName">Công ty: _________</div>
        <div style="font-size:13px;color:var(--muted)" id="companyAddr">Địa chỉ: _________</div>
      </div>
      <div class="meta">
        <div>Số phiếu: <strong id="soPhieu">-</strong></div>
        <div id="ngayXuatMeta">Ngày: -</div>
      </div>
    </header>

    <h1>PHIẾU XUẤT KHO</h1>

    <table>
      <tr>
        <td><strong>Hạng mục</strong></td><td id="hangMuc">-</td><td><strong>Nhóm NCC</strong></td><td id="nhomNcc">-</td>
      </tr>
      <tr>
        <td><strong>Nội dung</strong></td><td id="noiDung">-</td><td><strong>Nhà cung cấp</strong></td><td id="nhaCung">-</td>
      </tr>
      <tr>
        <td><strong>Xưởng</strong></td><td id="xuong">-</td><td><strong>Trạng thái</strong></td><td id="trangThai">-</td>
      </tr>
      <tr>
        <td><strong>Ghi chú</strong></td><td id="ghiChu">-</td><td><strong>Người lập</strong></td><td id="nguoiLap">-</td>
      </tr>
    </table>

    <h3 style="margin-top:12px">Danh sách mặt hàng</h3>
    <table class="items" id="itemsTable">
      <thead>
        <tr><th style="width:6%">STT</th><th style="width:52%">Tên hàng</th><th style="width:12%">Đơn vị</th><th style="width:12%">Số lượng</th><th style="width:18%">Ghi chú</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <div style="display:flex;justify-content:space-between;margin-top:20px">
      <div>
        <div style="font-size:13px;color:var(--muted)">Người nhận</div>
        <div style="margin-top:36px">(Ký, ghi rõ họ tên)</div>
      </div>
      <div>
        <div style="font-size:13px;color:var(--muted)">Người lập</div>
        <div style="margin-top:36px" id="nguoiLapSign">-</div>
      </div>
    </div>
  </div>

  <!-- libs for PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* -------------------------
  HỖ TRỢ 2 PHƯƠNG ÁN:
  - Query: URL chứa các param như so_phieu, hang_muc, items (items có thể là JSON string hoặc dạng "a~b~c~d;;e~f~...").
  - API: URL có param api_url hoặc api_base + api_id -> fetch JSON.
-------------------------*/

function getParams(){
  const ps = new URLSearchParams(location.search);
  const obj = {};
  for(const [k,v] of ps.entries()) obj[k]=v;
  return obj;
}

function safeText(s){ if(s===null||s===undefined||s==='') return '-'; return String(s); }
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// parseItems: chấp nhận
//  - JSON array string: [{"name":"...","unit":"...","qty":...,"note":"..."}]
//  - chuỗi phân tách bằng ';;' và mỗi phần 'name~unit~qty~note'
function parseItems(raw){
  if(!raw) return [];
  // nếu là JSON
  try{
    const j = JSON.parse(raw);
    if(Array.isArray(j)) return j.map(it=>({name:it.name||it.ten||'', unit:it.unit||it.don_vi||'', qty:it.qty||it.so_luong||'', note:it.note||it.ghi_chu||''}));
  }catch(e){}
  // nếu dạng 'a~b~c~d;;e~f~g~h'
  try{
    const parts = raw.split(';;').map(x=>x.trim()).filter(Boolean);
    if(parts.length>0){
      return parts.map(p=>{
        const [name,unit,qty,note] = p.split('~').map(x=>x?x.trim():'');
        return {name:name||'', unit:unit||'', qty:qty||'', note:note||''};
      });
    }
  }catch(e){}
  // fallback
  return [{name:raw, unit:'', qty:'', note:''}];
}

function fillFromObject(data){
  // map nhiều tên field để an toàn
  const pick = (obj, names)=> names.reduce((acc,n)=> acc || obj[n] || obj[n.toLowerCase()] || null, null);
  document.getElementById('soPhieu').textContent = safeText(pick(data, ['so_phieu','soPhieu','so','soPhieu']));
  document.getElementById('hangMuc').textContent = safeText(pick(data, ['hang_muc','hangMuc','hangmuc']));
  document.getElementById('nhomNcc').textContent = safeText(pick(data, ['nhom_ncc','nhomNcc','nhomncc']));
  document.getElementById('noiDung').textContent = safeText(pick(data, ['noi_dung','noiDung','noi']));
  document.getElementById('nhaCung').textContent = safeText(pick(data, ['nha_cung','nhaCung','nha']));
  document.getElementById('xuong').textContent = safeText(pick(data, ['xuong','xuong']));
  document.getElementById('trangThai').textContent = safeText(pick(data, ['trang_thai','trangThai']));
  document.getElementById('ghiChu').textContent = safeText(pick(data, ['ghi_chu','ghiChu']));
  document.getElementById('nguoiLap').textContent = safeText(pick(data, ['nguoi_lap','nguoiLap']));
  if(document.getElementById('nguoiLapSign')) document.getElementById('nguoiLapSign').textContent = safeText(pick(data, ['nguoi_lap','nguoiLap']));
  const ngay = pick(data, ['ngay_xuat','ngayXuat','ngay','date']);
  if(document.getElementById('ngayXuatMeta')) document.getElementById('ngayXuatMeta').textContent = ngay?('Ngày: ' + ngay): 'Ngày: -';

  // items
  const itemsRaw = pick(data, ['items','Items','danh_sach','items_json']) || '';
  const items = Array.isArray(itemsRaw) ? itemsRaw.map(it=>({name:it.name||it.ten||'',unit:it.unit||'',qty:it.qty||'',note:it.note||''})) : parseItems(itemsRaw);
  const tbody = document.querySelector('#itemsTable tbody');
  tbody.innerHTML = '';
  if(items.length===0){
    const tr = document.createElement('tr');
    tr.innerHTML = '<td colspan="5" style="text-align:center;color:var(--muted)">Không có mặt hàng</td>';
    tbody.appendChild(tr);
  } else {
    items.forEach((it,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(it.name)}</td><td>${escapeHtml(it.unit)}</td><td>${escapeHtml(it.qty)}</td><td>${escapeHtml(it.note)}</td>`;
      tbody.appendChild(tr);
    });
  }
}

/* ----- LOGIC KHI LOAD TRANG -----
  1) Nếu URL có api_url => fetch JSON từ api_url
  2) Else nếu có api_base + api_id => build URL và fetch
  3) Else nếu có bất kỳ query param (so_phieu / hang_muc / items ...) => fill trực tiếp từ query
*/
async function init(){
  const params = getParams();
  // api_url trực tiếp
  if(params.api_url){
    try{
      const r = await fetch(decodeURIComponent(params.api_url));
      const j = await r.json();
      fillFromObject(j);
      return;
    }catch(e){ console.error('Fetch api_url failed', e); }
  }
  // api_base + api_id
  if(params.api_base && params.api_id){
    const url = params.api_base.replace(/\/+$/,'') + '/' + encodeURIComponent(params.api_id);
    try{
      const r = await fetch(url);
      const j = await r.json();
      fillFromObject(j);
      return;
    }catch(e){ console.error('Fetch api_base failed', e); }
  }
  // query direct - có params -> dùng trực tiếp
  if(Object.keys(params).length){
    fillFromObject(params);
    return;
  }
  // không có dữ liệu
  console.info('No params or api provided. Page shows empty form.');
}

document.getElementById('btnPrint').addEventListener('click', ()=>window.print());
document.getElementById('btnPdf').addEventListener('click', async ()=>{
  const area = document.getElementById('printArea');
  const canvas = await html2canvas(area, {scale:2, useCORS:true});
  const imgData = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({unit:'mm', format:'a4'});
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  const imgRatio = canvas.width / canvas.height;
  let renderWidth = pageWidth - 12;
  let renderHeight = renderWidth / imgRatio;
  if(renderHeight > pageHeight - 12){
    renderHeight = pageHeight - 12;
    renderWidth = renderHeight * imgRatio;
  }
  const x = (pageWidth - renderWidth)/2, y = 6;
  pdf.addImage(imgData, 'PNG', x, y, renderWidth, renderHeight);
  const params = new URLSearchParams(location.search);
  const filename = (params.get('so_phieu') || params.get('soPhieu') || 'phieu').replace(/[^a-z0-9_\-]/ig,'_');
  pdf.save(filename + '.pdf');
});

document.getElementById('btnLoadApi').addEventListener('click', ()=>{
  const url = document.getElementById('apiUrlInput').value.trim();
  if(!url) return alert('Nhập API URL vào ô bên cạnh rồi thử lại.');
  fetch(url).then(r=>r.json()).then(j=>fillFromObject(j)).catch(e=>alert('Load API thất bại: '+e.message));
});

init();
</script>
</body>
</html>
